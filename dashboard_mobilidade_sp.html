<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Mobilidade Urbana - São Paulo</title>
    <!-- Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts para uma tipografia mais agradável -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glowing-dot { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.7); }
            50% { box-shadow: 0 0 20px rgba(74, 222, 128, 1); }
        }
        /* Estilo para o estado de carregamento */
        .loading-placeholder {
            background-color: #374151; /* gray-700 */
            border-radius: 0.5rem;
            animation: pulse-bg 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-bg {
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Painel de Mobilidade Urbana</h1>
            <p class="text-gray-400 mt-2">Análise de Dados de Deslocamento em São Paulo (PySpark)</p>
        </header>

        <div id="loading-state" class="text-center text-gray-400">
            <p>Carregando dados da análise...</p>
        </div>

        <div id="dashboard-content" class="hidden">
            <!-- Seção de Métricas Principais (KPIs) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                    <div class="bg-blue-500 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></div>
                    <div>
                        <p class="text-gray-400 text-sm">Total de Viagens</p>
                        <p id="kpi-total-viagens" class="text-2xl font-bold text-white loading-placeholder w-16 h-8"></p>
                    </div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                    <div class="bg-green-500 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
                    <div>
                        <p class="text-gray-400 text-sm">Principal Modal</p>
                        <p id="kpi-principal-modal" class="text-2xl font-bold text-white loading-placeholder w-24 h-8"></p>
                    </div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                    <div class="bg-yellow-500 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <div>
                        <p class="text-gray-400 text-sm">Pico da Manhã</p>
                        <p id="kpi-pico-manha" class="text-2xl font-bold text-white loading-placeholder w-32 h-8"></p>
                    </div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                    <div class="bg-red-500 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <div>
                        <p class="text-gray-400 text-sm">Pico da Tarde</p>
                        <p id="kpi-pico-tarde" class="text-2xl font-bold text-white loading-placeholder w-32 h-8"></p>
                    </div>
                </div>
            </div>

            <!-- Seção de Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Volume de Viagens por Hora do Dia</h2>
                    <div class="h-80"><canvas id="hourly-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Distribuição por Modal</h2>
                    <div class="h-80 flex items-center justify-center"><canvas id="modal-chart"></canvas></div>
                </div>
            </div>

            <!-- Seção de Insights e Recomendações -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white flex items-center"><span class="relative flex h-3 w-3 mr-3"><span class="absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 animate-ping"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500 glowing-dot"></span></span>Monitoramento em Tempo Real</h2>
                    <div id="realtime-log" class="bg-gray-900 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm space-y-2"></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Conclusões e Recomendações</h2>
                    <ul class="list-disc list-inside space-y-3 text-gray-300">
                        <li><span class="font-semibold text-blue-400">Otimizar Rotas de Ônibus:</span> Focar na otimização das rotas mais críticas nos horários de pico para reduzir tempo e lotação.</li>
                        <li><span class="font-semibold text-green-400">Incentivar Modais Alternativos:</span> Criar políticas de integração entre transporte público e aplicativos para maior flexibilidade.</li>
                        <li><span class="font-semibold text-yellow-400">Expandir Análise de Dados:</span> Integrar novas fontes de dados (sensores, bilhetagem) para uma visão 360º da mobilidade.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CORREÇÃO: DADOS DO DASHBOARD EMBUTIDOS DIRETAMENTE ---
        const dashboardJSONData = {
            "kpis": {
                "total_viagens": 13,
                "principal_modal": "Onibus",
                "pico_manha": "08:00 - 09:00",
                "pico_tarde": "17:00 - 19:00"
            },
            "graficos": {
                "distribuicao_modal": [
                    { "tipo_transporte": "onibus", "total": 7 },
                    { "tipo_transporte": "metro", "total": 3 },
                    { "tipo_transporte": "app", "total": 3 }
                ],
                "volume_por_hora": [
                    { "hora_do_dia": 8, "total": 3 },
                    { "hora_do_dia": 9, "total": 2 },
                    { "hora_do_dia": 12, "total": 1 },
                    { "hora_do_dia": 13, "total": 1 },
                    { "hora_do_dia": 14, "total": 1 },
                    { "hora_do_dia": 17, "total": 2 },
                    { "hora_do_dia": 18, "total": 3 }
                ]
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            let modalChartInstance = null;
            let hourlyChartInstance = null;

            Chart.defaults.color = '#a0aec0';
            Chart.defaults.borderColor = '#4a5568';

            // --- FUNÇÃO PARA CARREGAR DADOS (AGORA USA A VARIÁVEL LOCAL) ---
            function loadDashboardData() {
                try {
                    // Usa a variável 'dashboardJSONData' diretamente, sem 'fetch'
                    const data = dashboardJSONData;
                    
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('dashboard-content').classList.remove('hidden');

                    updateKPIs(data.kpis);
                    createModalChart(data.graficos.distribuicao_modal);
                    createHourlyChart(data.graficos.volume_por_hora);

                } catch (error) {
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-400">Falha ao processar os dados embutidos. Verifique o objeto 'dashboardJSONData'.</p>`;
                    console.error("Erro detalhado:", error);
                }
            }
            
            function updateKPIs(kpis) {
                const formatNumber = (num) => num.toLocaleString('pt-BR');
                
                const kpiTotal = document.getElementById('kpi-total-viagens');
                kpiTotal.textContent = formatNumber(kpis.total_viagens);
                kpiTotal.classList.remove('loading-placeholder', 'w-16', 'h-8');

                const kpiModal = document.getElementById('kpi-principal-modal');
                kpiModal.textContent = kpis.principal_modal;
                kpiModal.classList.remove('loading-placeholder', 'w-24', 'h-8');
                
                const kpiManha = document.getElementById('kpi-pico-manha');
                kpiManha.textContent = kpis.pico_manha;
                kpiManha.classList.remove('loading-placeholder', 'w-32', 'h-8');

                const kpiTarde = document.getElementById('kpi-pico-tarde');
                kpiTarde.textContent = kpis.pico_tarde;
                kpiTarde.classList.remove('loading-placeholder', 'w-32', 'h-8');
            }

            function createModalChart(data) {
                const ctx = document.getElementById('modal-chart').getContext('2d');
                const labels = data.map(item => item.tipo_transporte.charAt(0).toUpperCase() + item.tipo_transporte.slice(1));
                const values = data.map(item => item.total);

                if (modalChartInstance) modalChartInstance.destroy();
                modalChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                            borderColor: ['#3B82F6', '#10B981', '#EF4444'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: '#e2e8f0', padding: 20, font: { size: 14 } } } }
                    }
                });
            }

            function createHourlyChart(data) {
                const ctx = document.getElementById('hourly-chart').getContext('2d');
                const fullHoursData = Array(24).fill(0);
                data.forEach(item => {
                    fullHoursData[item.hora_do_dia] = item.total;
                });
                const labels = Array.from({ length: 24 }, (_, i) => `${i}h`);
                
                if (hourlyChartInstance) hourlyChartInstance.destroy();
                hourlyChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Volume de Viagens',
                            data: fullHoursData,
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, grid: { color: '#2d3748' } }, x: { grid: { display: false } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // --- SIMULAÇÃO DE LOGS EM TEMPO REAL (INALTERADO) ---
            const logContainer = document.getElementById('realtime-log');
            const sampleLogs = [
                { time: '18:32:15', msg: 'Pico de demanda detectado na Linha 1-Azul.', type: 'warn' },
                { time: '18:32:48', msg: 'Trânsito intenso na Marginal Pinheiros.', type: 'error' },
                { time: '18:33:05', msg: 'Frota de ônibus reforçada na região da Paulista.', type: 'info' },
                { time: '18:33:51', msg: 'Operação normal na Linha 4-Amarela.', type: 'success' },
            ];
            let logIndex = 0;
            const addLogEntry = () => {
                if (!logContainer) return;
                const log = sampleLogs[logIndex % sampleLogs.length];
                const newLog = document.createElement('div');
                let colorClass = 'text-gray-400';
                if (log.type === 'warn') colorClass = 'text-yellow-400';
                if (log.type === 'error') colorClass = 'text-red-400';
                if (log.type === 'info') colorClass = 'text-blue-400';
                if (log.type === 'success') colorClass = 'text-green-400';
                newLog.innerHTML = `<span class="text-gray-500">${log.time}</span> <span class="${colorClass}">${log.msg}</span>`;
                logContainer.prepend(newLog);
                if (logContainer.children.length > 10) {
                    logContainer.removeChild(logContainer.lastChild);
                }
                logIndex++;
            };
            setInterval(addLogEntry, 3500);

            // --- INICIALIZAÇÃO ---
            loadDashboardData();
        });
    </script>
</body>
</html>

